<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>IndexedDB video store</title>
  <style>
    html {
      font-family: sans-serif;
    }
    body {
      margin: 0 auto;
      max-width: 800px;
    }
    header,
    footer {
      background-color: green;
      color: white;
      line-height: 100px;
      padding: 0 20px;
    }
    article {
      padding: 10px;
      margin: 10px 0;
      border: 1px solid black;
      background-color: #eee;
    }
    h2 {
      margin: 10px 0;
    }
    video {
      margin: 0 auto;
      border: 1px solid black;
      display: block;
    }
    button {
      display: block;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <header>
    <h1>IndexedDB video store</h1>
  </header>
  <main>
    <video controls controlslist="nodownload">
      <source src="videos/elf.mp4" type="video/mp4">
      <p>It looks like your browser doesn't support HTML5 video. Here is a <a href="videos/elf.mp4">link to the movie</a>.</p>
    </video>
    <p id="online" hidden>
      <input type="checkbox" id="save" name="save">
      <label for="save">Save for offline</label>
    </p>
  </main>
  <script>

    // IndexDB functionality
    window.onload = function() {
      // js import
      const CACHE_VERSION = 1;
      const CURRENT_CACHE = 'SurfFlix-v' + CACHE_VERSION;
      // other variables
      const ONLINE = document.getElementById('online');
      const SAVE_CHECKBOX = document.querySelector('#save');
      const SAVE_LABEL = document.querySelector('label');
      const CACHE_URLS = [
        '/testing/new.html'
      ];
      const VIDEO = {
        'name': 'elf'
      };
      // Create an instance of a db object for us to store our database in
      let db;
      
      // init function
      function init() {
        
        // Open transaction, get object store, and get() the video by name
        let objectStore = db.transaction('videos_os').objectStore('videos_os');
        let request = objectStore.get(VIDEO.name);
        request.onsuccess = function() {
          // If elf exists in the database (is not undefined)
          if (request.result) {
            // Result good
            console.log('found it');
          }
        }; // end onsuccess request
        request.onerror = function() {
          console.log('Elf not in database: ', request.error);
        }
      } // end init function

      // Open the database; it is created if it doesn't already exist
      let request = window.indexedDB.open('videos_db', 1);
  
      // onerror handler signifies that the database didn't open successfully
      request.onerror = function() {
        console.log('Database failed to open');
      }; // end onerror handler

      // onsuccess handler signifies that the database opened successfully
      request.onsuccess = function() {
        console.log('Database opened successfully');
        // Store the opened database object in the db variable
        db = request.result;
        if (db.objectStoreNames.length > 0) {
          let objectStore = db.transaction('videos_os').objectStore('videos_os');
          let request = objectStore.get(VIDEO.name);
          request.onsuccess = function() {
            // If elf exists in the database (is not undefined)
            if (request.result) {
              // Result good
              console.log('found elf');
              if (cacheExists()){
                console.log('Taking video from IDB');
                displayVideo(request.result.mp4, request.result.name);
                ONLINE.removeAttribute('hidden');
                SAVE_CHECKBOX.checked;
                SAVE_LABEL.innerText = "Saved";
              }
            }
          }; // end onsuccess request
        }
        else {
          console.log('No os in database');
          if (userOnline()) {
            ONLINE.removeAttribute('hidden');
          }
        }
      }; // end onsuccess handler

      function cacheExists() {
        caches.has(CURRENT_CACHE).then(function(response) {
          if (response) {
            return true;
          } else {
            return false;
          }
        }); 
      }
      // displayVideo() function
      function displayVideo(mp4Blob, title) {
        // Create object URLs out of the blobs
        let mp4URL = URL.createObjectURL(mp4Blob);
        // Replace video source with mp4Blob from IDB
        const SOURCE = document.querySelector('source');
        SOURCE.src = mp4URL;
      } // end displayVideo function
      function userOnline() {
        if (window.navigator.onLine === true) {
          return true;
        } else {
          return false;
        } 
      }

      SAVE_CHECKBOX.addEventListener('change', function(event) {
        if (SAVE_CHECKBOX.checked) {
          // Check if a service worker can be used in this browser, log message
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then((reg) => {
              console.log('Registration succeeded. Scope is: ' + reg.scope);
            }).catch((error) => {
              console.log('Registration failed: ' + error);
            });
          }
          caches.open(CURRENT_CACHE).then(function(cache) {
            let updateCache = cache.addAll(CACHE_URLS);
            updateCache.then(function() {
              console.log('Page files now cached for offline use.');
            }).catch(function (error) {
              console.log('Could not populate cache: ' + error);
            });
          });
          //TODO: handle video file
          SAVE_LABEL.innerText = 'Saved';
        } else { // if save checkbox is unchecked
          //TODO: delete video file from IDB
          // Open the cache and delete the movie
          caches.open(CURRENT_CACHE).then(function(cache) {
            cache.delete(CACHE_URLS).then(function(response) {
              console.log('Page files removed from cache.');
            });
          });
          // If the user if online/offline, update the UI accordingly
          if (window.navigator.onLine) {
            SAVE_LABEL.innerText = 'Save for offline';
          } else {
            ONLINE.setAttribute('hidden', '');
          }
        } 
      }); // end save checkbox event listener
      
    }; // end window onload
    // end IndexDB functionality
    
    /*
    On content load
      If the video file is in IndexDB and page cache exists
        Show the online paragraph
        Check checkbox, update label to read Saved, and change video src to be file from IndexDB
      Else
        If user is online
          Show the online paragraph
          
    On checkbox change
      If checkbox checked
        Check if browser supports Service Workers
          If so, register SW
        If no support
          Log error
        Save the new.html file to the cache
        Save the video file to the IndexDB
        Change video src to be file from IndexDB
      Else if checkbox unchecked
        Delete new.html file from cache
        Delete the video file from the IndexDB
        Change video src to be network file
        If the user is online
          Update label to read Save for Offline
        Else if the user isn't online
          Set the online paragraph to hidden 
    */
  </script>
</body>
</html>
