<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>IndexedDB video store</title>
  <style>
    html {
      font-family: sans-serif;
    }
    body {
      margin: 0 auto;
      max-width: 800px;
    }
    header,
    footer {
      background-color: green;
      color: white;
      line-height: 100px;
      padding: 0 20px;
    }
    article {
      padding: 10px;
      margin: 10px 0;
      border: 1px solid black;
      background-color: #eee;
    }
    h2 {
      margin: 10px 0;
    }
    video {
      margin: 0 auto;
      border: 1px solid black;
      display: block;
    }
    button {
      display: block;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <header>
    <h1>IndexedDB video store</h1>
  </header>
  <main>
    <video controls controlslist="nodownload">
      <source src="videos/elf.mp4" type="video/mp4">
      <p>It looks like your browser doesn't support HTML5 video. Here is a <a href="videos/elf.mp4">link to the movie</a>.</p>
    </video>
    <p id="online" hidden>
      <input type="checkbox" id="save" name="save">
      <label for="save">Save for offline</label>
    </p>
  </main>
  <script>

    // IndexDB functionality
    window.onload = function() {
      // js import
      const CACHE_VERSION = 1;
      const CURRENT_CACHE = 'SurfFlix-v' + CACHE_VERSION;
      // other variables
      const SAVE_CHECKBOX = document.querySelector('#save');
      const SAVE_LABEL = document.querySelector('label');
      let urlsToCache = [
        '/vids/movies/offline/',
        '/vids/movies/offline/index.html'
      ];
      const VIDEO = {
        'name': 'elf'
      };
      // Create an instance of a db object for us to store our database in
      let db;
      
      // init function
      function init() {
        
        // Open transaction, get object store, and get() the video by name
        let objectStore = db.transaction('videos_os').objectStore('videos_os');
        let request = objectStore.get(VIDEO.name);
        request.onsuccess = function() {
          // If elf exists in the database (is not undefined)
          if (request.result) {
            // Result good
            console.log('found it');
          }
        }; // end onsuccess request
        request.onerror = function() {
          console.log('Elf not in database: ', request.error);
        }
      } // end init function

      // Open the database; it is created if it doesn't already exist
      let request = window.indexedDB.open('videos_db', 1);
  
      // onerror handler signifies that the database didn't open successfully
      request.onerror = function() {
        console.log('Database failed to open');
      }; // end onerror handler

      // onsuccess handler signifies that the database opened successfully
      request.onsuccess = function() {
        console.log('Database opened succesfully');
        // Store the opened database object in the db variable. This is used a lot below
        db = request.result;
        console.log(db);
        console.log(db.objectStoreNames);
        //init();
      }; // end onsuccess handler

    }; // end window onload
    // end IndexDB functionality

    /* 
    Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').then((reg) => {
        console.log('Registration succeeded. Scope is: ' + reg.scope);
      }).catch((error) => {
        console.log('Registration failed: ' + error);
      });
    }
    */
    
    /*
    On content load
      If the video file is in IndexDB and page cache exists
        Show the online paragraph
        Check checkbox, update label to read Saved, and change video src to be file from IndexDB
      Else
        If user is online
          Show the online paragraph
          
    On checkbox change
      If checkbox checked
        Check if browser supports Service Workers
          If so, register SW
        If no support
          Log error
        Save the new.html file to the cache
        Save the video file to the IndexDB
        Change video src to be file from IndexDB
      Else if checkbox unchecked
        Delete new.html file from cache
        Delete the video file from the IndexDB
        Change video src to be network file
        If the user is online
          Update label to read Save for Offline
        Else if the user isn't online
          Set the online paragraph to hidden 
    */
  </script>
</body>
</html>
